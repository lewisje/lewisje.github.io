<!DOCTYPE html>
<html>
<head>
<title>Testing nodeInsertion</title>
<script type="text/javascript"><!--//--><![CDATA[//><!--
var nodeInsertion = (function (document, undefined) {
'use strict';
function noop() {}
var result = {add: noop, remove: noop};

// Every browser that supports animations also has String#trim
if (typeof String.prototype.trim !== 'function') return result;

// a stylesheet that holds our special keyframe code: https://davidwalsh.name/add-rules-stylesheets
var animName = ('node_' + Math.random() + '_inserted').split('.').join(''), sheet = (function () {
  var style = document.createElement('style');

  // Add a media (and/or media query) here if you'd like!
  // style.setAttribute('media', 'screen')
  // style.setAttribute('media', 'only screen and (max-width : 1024px)')
  style.appendChild(document.createTextNode([/*'@-o-','@-moz-', '@-webkit-',*/ '@', ''].join('keyframes ' +
    animName + ' {\n  from {opacity: 0.99;}\n  to {opacity: 1;}\n}\n')));
  document.head.appendChild(style);
  return style.sheet;
})(), addCSSRule = function (sheet, selector, rules, index) {
  if (typeof sheet.insertRule === 'function') addCSSRule = function addCSSRule(sheet, selector, rules, index) {
    return sheet.insertRule(selector + '{' + rules + '}', index);
  };
  else if (typeof sheet.addRule === 'function') addCSSRule = function addCSSRule(sheet, selector, rules, index) {
    return sheet.addRule(selector, rules, index);
  };
  else addCSSRule = noop;
  return addCSSRule(sheet, selector, rules, index);
}, animEvents = [/*'oAnimationStart','mozAnimationstart', 'MSAnimationStart', 'webkitAnimationStart',*/ 'animationstart'], alen = animEvents.length,
  listeners = [], canDelete = typeof sheet.deleteRule === 'function', prefixes = ['-o-', '-moz-', '-webkit-', '', ''],
  insertionAnim = prefixes.join('animation-duration: 0.001s;') + prefixes.join('animation-name: ' + animName + ';');

if (addCSSRule === noop) return result;
console.log(insertionAnim);

function checkRule(rules, selector, index) {
  return index in rules && rules[index].cssText.split('{')[0].indexOf(selector) !== -1;
}
function defaultSel(sel, def) {
  return typeof sel !== 'string' ? def : sel.trim() || def;
}

// listens solely for new direct descendants
// returns index to be passed into the `remove` method
result.add = function add(func, sel, desc) {
  if (typeof func !== 'function') throw new TypeError('A function must be passed in');
  var s = defaultSel(sel, 'body'), d = defaultSel(desc, '*'), elts = document.querySelectorAll(s), i = elts.length,
    rules = sheet.cssRules, len = rules.length, selector = s + ' > ' + d, wrapped = function wrapped(e) {
      var evt = e || event;
      if (evt.animationName === animName) return console.log('started'), func.call(this, evt);
    }, j, count = 0, addition = function addition(i, j) {
      setTimeout(function () {
        elts[i].addEventListener(animEvents[j], wrapped, false);
      }, 0);
    };
  listeners.push({func: wrapped, sel: s, desc: d});
  while (i--) for (j = alen; j--;) console.log(++count + ' | addition'), addition(i, j);
  for (i = 0; i < len;) if (checkRule(rules, selector, i)) return listeners.length;
  addCSSRule(sheet, selector, insertionAnim, 0);
  return listeners.length;
};

result.remove = function remove(index) {
  if (!listeners[index - 1]) return;
  var listener = listeners[index - 1], func = listener.func, s = listener.sel,
    elts = document.querySelectorAll(s), i = elts.length, j, count = 0,
    removal = function removal(i, j) {
      setTimeout(function () {
        elts[i].removeEventListener(animEvents[j], func, false);
      }, 0);
    };
  while (i--) for (j = alen; j--;) console.log(++count + ' | removal'), removal(i, j);
  if (canDelete) {
    var rules = sheet.cssRules, selector = s + ' > ' +  listener.desc, len = rules.length,
      deletion = function deletion(i) {
        setTimeout(function () {
          if (checkRule(rules, selector, i)) sheet.deleteRule(i);
        }, 0);
      };
    for (i = 0; i < len;) console.log(++count + ' | deletion'), deletion(i);
  }
  listeners[index - 1] = null;
};
return result;
})(document);
window.addEventListener('DOMContentLoaded', function () {
'use strict';
if (typeof window.addEventListener !== 'function') throw new TypeError('This demonstration requires a newer browser');
var counter = document.getElementById('counter'), list = document.getElementById('list'), timer = null, listenId = null;
function listener() {
  console.log('listening');
  return counter.innerHTML = Number(counter.innerHTML) + 1;
}
function append() {
  var li = document.createElement('li');
  li.appendChild(document.createTextNode('lol'));
  console.log('appending');
  return list.appendChild(li);
}
function clearTimer() {
  if (timer) clearInterval(timer);
  timer = null;
}
function stopListening() {
  console.log(listenId);
  if (listenId) nodeInsertion.remove(listenId);
  console.log('stopped');
  listenId = null;
}
document.getElementById('start').addEventListener('click', function () {
  if (!timer) timer = setInterval(append, 1000);
}, false);
document.getElementById('stop').addEventListener('click', clearTimer, false);
document.getElementById('add').addEventListener('click', function () {
  console.log('starting to listen');
  if (!listenId) listenId = nodeInsertion.add(listener, '#list', 'li');
}, false);
document.getElementById('remove').addEventListener('click', stopListening, false);
document.getElementById('reset').addEventListener('click', function () {
  clearTimer();
  stopListening();
  counter.innerHTML = 0;
  list.innerHTML = '';
}, false);
}, false);//--><!]]></script>
</head>
<body>
  <button id="start">Start</button>
  <button id="stop">Stop</button>
  <button id="add">Add Listener</button>
  <button id="remove">Remove Listener</button>
  <button id="reset">Reset</button>
  <p id="counter">0</p>
  <ul id="list"></ul>
</body>
</html>
